# Project Specification: Lightweight ActivityPub Server & Client "Rox"

**Languages**: English | [日本語](./v1.md)

**Version:** 1.1.0
**Last Updated:** 2025-12-02
**Status:** Phase 6 Complete, Ready for Phase 7 (Plugin System)

## 1. Project Overview

### 1.1 Concept

* **Lightweight & High Performance:** Fully adopts Bun runtime and modern web standard technologies (Hono, Waku), aiming for lighter and faster operation than existing Misskey instances.
* **Infrastructure Agnostic:** Environment-independent design. Flexibly adapts from traditional VPS (Docker) operation to edge computing environments like Cloudflare Workers/D1 with simple configuration.
* **Misskey API Compatible:** Provides Misskey-compatible interfaces for frontend and external integrations, offering a seamless migration experience for existing Misskey users.

### 1.2 Target Environments

1. **Standard VPS / Dedicated Server:** Traditional hosting using Docker Compose, etc.
2. **Edge / Serverless:** Low-cost, high-scalability environments utilizing Cloudflare Workers, D1, R2, etc.

---

## 2. Technology Stack

| Category | Technology | Purpose & Rationale |
| :--- | :--- | :--- |
| **Runtime** | **Bun** | Fast JavaScript runtime, adopted as package manager and test runner. |
| **Language** | **TypeScript** | Quality assurance through type safety and improved development efficiency. |
| **Backend FW** | **Hono** | Ultra-lightweight framework compliant with web standards. High edge environment compatibility. |
| **Frontend FW** | **Waku** | Minimal configuration framework with native React Server Components (RSC) support. |
| **State Mgmt** | **Jotai** | Atomic state management library. High affinity with Waku, minimizes re-renders. |
| **UI Components** | **React Aria Components** | Accessible headless UI components. WAI-ARIA compliant. |
| **Styling** | **Tailwind CSS** | Utility-first CSS with excellent build-time size optimization. Uses OKLCH color space. |
| **Internationalization** | **Lingui** | Readable, automated, and optimized (3kb) i18n library. Compile-time optimization supported. |
| **ORM** | **Drizzle ORM** | TypeScript-first and lightweight. SQL-like operations possible, easy multi-DB support. |
| **Queue** | **Dragonfly** / **BullMQ** | Async job processing in VPS environments (ActivityPub delivery, etc.). Redis compatible. |
| **Code Quality** | **oxc** | Rust-based toolchain (Linting & Formatting). ESLint/Prettier replacement. |

---

## 3. Architecture and Abstraction Design

To separate environment dependencies (DB, storage) from business logic, **Repository Pattern** and **Adapter Pattern** are adopted.

### 3.1 Directory Structure

```text
src/
├── adapters/           # Infrastructure implementations (Adapter Pattern)
│   ├── storage/
│   │   ├── LocalStorageAdapter.ts
│   │   └── S3StorageAdapter.ts
│   └── email/          # (Future)
├── db/
│   ├── schema/         # Drizzle schema definitions
│   │   ├── pg.ts       # PostgreSQL
│   │   ├── mysql.ts    # MySQL/MariaDB
│   │   └── sqlite.ts   # SQLite/D1
│   └── index.ts        # DB connection initialization
├── interfaces/         # Abstract definitions (Interface)
│   ├── IFileStorage.ts
│   └── repositories/
│       ├── INoteRepository.ts
│       └── IUserRepository.ts
├── repositories/       # DB operation implementations (Repository Pattern)
│   ├── pg/             # Postgres implementations
│   ├── mysql/          # MySQL implementations
│   └── d1/             # D1(SQLite) implementations
├── services/           # Business logic
├── routes/             # Hono endpoints
└── index.ts            # Application entry point
```

### 3.2 Database Abstraction (Database Layer)

Users can select the backend DB via the `DB_TYPE` environment variable.

* **Supported Databases:**
  * PostgreSQL (Default/Recommended for VPS)
  * MySQL / MariaDB
  * SQLite / Cloudflare D1
* **Implementation Policy:**
  * Define interfaces like `INoteRepository`, and Controllers (Hono Routes) depend only on these.
  * At application startup (DI container construction), inject concrete Repository classes (`PostgresNoteRepo` or `D1NoteRepo`) based on environment variables.

### 3.3 Storage Abstraction (Storage Layer)

Users can select the media storage destination via the `STORAGE_TYPE` environment variable.

* **Supported Storage:**
  * **Local:** Save to local filesystem (using `Bun.write`). Primarily for development and single-server operation.
  * **S3 Compatible:** Save to AWS S3, Cloudflare R2, MinIO, etc. (using AWS SDK).
* **Implementation Policy:**
  * Define `IFileStorage` interface (`save`, `delete`, `getUrl`).
  * For S3-compatible storage, read endpoint, region, and credentials from environment variables.

---

## 4. Functional Requirements (Phased Implementation)

### Phase 1: Foundation ✅ Complete

* [x] Bun + Hono project initialization (monorepo structure).
* [x] Drizzle ORM setup.
  * PostgreSQL schema definition and migration environment construction complete.
* [x] DB/storage switching logic implementation via environment variables (`.env`).
* [x] Dependency injection (DI) mechanism construction (using Hono Context).

### Phase 2: Misskey-Compatible API Implementation (Local API) ✅ Complete

* [x] **Authentication:** Session generation, authentication verification (`/api/auth/*`)
  * Token-based authentication, session management
  * Passkey support (WebAuthn)
* [x] **Account Management:**
  * User registration (`/api/users`)
  * Profile editing (`/api/users/@me`)
  * User information retrieval (`/api/users/:id`, `/api/users/show`)
* [x] **Note Features:**
  * Post creation (`/api/notes/create`): Text, image attachments, CW, visibility, reply, renote support
  * Timeline retrieval: Local, social, home timeline (`/api/notes/*-timeline`)
  * User timeline (`/api/notes/user-notes`)
  * Reactions (`/api/notes/reactions/*`): Add/remove emoji
  * Post deletion (`/api/notes/delete`)
* [x] **Follow Features:**
  * Follow/Unfollow (`/api/following/*`)
  * Followers/Following list retrieval (`/api/users/followers`, `/api/users/following`)
* [x] **File Management:** Drive functionality (`/api/drive/*`)
  * Upload, delete, list retrieval
  * Local storage support

### Phase 3: Frontend Implementation (Waku Client) ✅ Complete

* [x] **Environment Setup:**
  * Waku 0.27.1 + Jotai setup complete
  * Tailwind CSS v4 + OKLCH color space custom colors
  * Lingui i18n support (Japanese/English, 87 messages)
  * React Aria Components integration
* [x] **Authentication Flow:**
  * Login/Signup pages
  * Passkey authentication (WebAuthn)
  * Password authentication
  * Session management (localStorage persistence)
* [x] **Timeline Features:**
  * Local/Social/Home timeline display
  * Infinite scroll (Intersection Observer + custom hooks)
  * Skeleton loading, error display
  * Timeline tab switching
* [x] **Post Features (NoteComposer):**
  * Text posting, image attachments (multiple support)
  * Drag & drop file uploads
  * Image preview display
  * Reply, renote functionality
  * CW (Content Warning) support
  * Visibility settings (public/home/followers)
  * File upload progress display
* [x] **Post Display (NoteCard):**
  * Reaction display, add, remove
  * Renote functionality
  * Follow/Unfollow button
  * Image modal (zoom, pan, gallery navigation)
  * Post deletion
  * Content Warning expansion
* [x] **User Profile Page:**
  * Profile information display (avatar, banner, bio)
  * Statistics (posts, followers, following count)
  * Follow/Unfollow button
  * User's post list
  * Dynamic routing (`/[username]`)
* [x] **UI/UX Improvements:**
  * Loading indicators (Spinner, ProgressBar, Skeleton)
  * Error display and retry functionality
  * Image fullscreen modal
  * Responsive design
* [x] **Accessibility:**
  * Keyboard navigation (j/k, arrow keys, Home/End)
  * Focus management (modal focus trapping)
  * Proper ARIA attribute settings (role, aria-label, aria-expanded, etc.)
  * Screen reader support (sr-only class usage)

### Phase 4: ActivityPub Federation ✅ Complete

* [x] **Actor Implementation:** JSON-LD (Person) return at `/users/:username`.
* [x] **WebFinger:** `/.well-known/webfinger` implementation.
* [x] **Signature Processing:** HTTP Signatures (RSA-SHA256 / hs2019) implementation.
* [x] **Delivery System:**
  * Activity reception and verification at Inbox (`/users/:username/inbox`).
  * Async delivery to external servers using Job Queue (Dragonfly/BullMQ).
* [x] **Activity Support:**
  * Follow/Accept/Reject/Undo(Follow)
  * Create/Update/Delete (Note)
  * Like/Undo(Like)
  * Announce/Undo(Announce)
* [x] **Federation Testing Complete:**
  * GoToSocial (Latest) - ✅ Verified
  * Mastodon (v4.3.2) - ✅ Verified
  * Misskey (v2025.11.1-alpha.2) - ✅ Verified
* [x] **Misskey Extension Support:**
  * `_misskey_reaction` custom emoji reactions (receive)

### Phase 5: Refactoring & Optimization ✅ Complete

* [x] **Code Refactoring:**
  * inbox.ts split (InboxService + Handler pattern)
  * ActivityPubDeliveryService responsibility separation
  * Service integration into DI container
  * Dynamic import organization
* [x] **Performance Optimization:**
  * Redis caching (timeline, user profiles)
  * Database connection pooling configuration
  * Query result caching (public timeline)
* [x] **Image Processing:**
  * WebP conversion/compression
  * Media proxy implementation
* [x] **Test Enhancement:**
  * Unit tests for major services added
  * Integration test organization

### Phase 6: Administration & Security ✅ Complete

* [x] **Administration Features:**
  * Instance block management UI
  * Moderation features
  * Admin dashboard
  * Role-based permission system
  * Instance settings management
* [x] **Security Enhancement:**
  * Rate limiting enhancement (ActivityPub inbox)
  * Delivery retry logic improvement
  * Structured logging introduction

### Phase 7: Plugin & Production (Planned)

* [ ] **Plugin System:**
  * Plugin API design
  * Hook point implementation
  * Sample plugin creation
* [ ] **Production Environment Support:**
  * Docker Compose production configuration
  * Monitoring/alerting setup (Prometheus/Grafana)
  * Backup/restore procedures
  * Documentation organization

---

## 5. Non-Functional Requirements

* **Security:**
  * Strict HTTP Signatures verification.
  * SQL injection protection (guaranteed by ORM usage).
  * XSS protection (using React/Waku standard escaping).
* **Performance:**
  * Fast First Contentful Paint (FCP) through Server Side Rendering (SSR/RSC).
  * Image WebP conversion/compression (optional).
* **Extensibility:**
  * Keep core logic loosely coupled considering future "plugin system" introduction.

---

## 6. Environment Variable Configuration Example (.env.example)

```ini
# Application Settings
PORT=3000
NODE_ENV=development
URL=https://myserver.example.com

# Database Settings (postgres, mysql, sqlite, d1)
DB_TYPE=postgres
DATABASE_URL=postgres://user:pass@localhost:5432/mysns

# Storage Settings (local, s3)
STORAGE_TYPE=local
# S3 Settings (when STORAGE_TYPE=s3)
S3_ENDPOINT=https://<accountid>.r2.cloudflarestorage.com
S3_BUCKET_NAME=my-bucket
S3_ACCESS_KEY=xxx
S3_SECRET_KEY=xxx
S3_REGION=auto
```

## 7. Naming

* Frontend: Waku Rox
* API Server: Hono Rox
