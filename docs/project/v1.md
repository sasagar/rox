# プロジェクト仕様書：軽量ActivityPubサーバー & クライアント "Rox"

**言語**: [English](./v1.en.md) | 日本語

**Version:** 1.1.0
**Last Updated:** 2025-12-02
**Status:** Phase 6 Complete, Ready for Phase 7 (Plugin System)

## 1\. プロジェクト概要

### 1.1 コンセプト

* **Lightweight & High Performance:** Bunランタイムと最新のWeb標準技術（Hono, Waku）を全面的に採用し、既存のMisskeyインスタンスよりも軽量かつ高速な動作を目指す。
* **Infrastructure Agnostic:** 実行環境を選ばない設計。従来のVPS（Docker）運用から、Cloudflare Workers/D1のようなエッジコンピューティング環境まで、設定一つで柔軟に対応する。
* **Misskey API Compatible:** フロントエンドおよび外部連携においてMisskey互換のインターフェースを持ち、既存のMisskeyユーザーが違和感なく移行できる体験を提供する。

### 1.2 ターゲット環境

1. **Standard VPS / Dedicated Server:** Docker Compose等を利用した従来型のホスティング。
2. **Edge / Serverless:** Cloudflare Workers, D1, R2などを活用した低コスト・高スケーラビリティ環境。

-----

## 2\. 技術スタック (Technology Stack)

| カテゴリ | 技術選定 | 選定理由・役割 |
| :--- | :--- | :--- |
| **Runtime** | **Bun** | 高速なJavaScriptランタイム、パッケージマネージャ、テストランナーとして採用。 |
| **Language** | **TypeScript** | 型安全性による品質担保と開発効率の向上。 |
| **Backend FW** | **Hono** | Web標準に準拠した超軽量フレームワーク。エッジ環境への互換性が高い。 |
| **Frontend FW** | **Waku** | React Server Components (RSC) をネイティブサポートする最小構成のフレームワーク。 |
| **State Mgmt** | **Jotai** | アトミックな状態管理ライブラリ。Wakuとの親和性が高く、再レンダリングを最小化する。 |
| **UI Components** | **React Aria Components** | アクセシビリティに優れたヘッドレスUIコンポーネント。WAI-ARIA準拠。 |
| **Styling** | **Tailwind CSS** | ビルド時のサイズ最適化に優れたユーティリティファーストCSS。OKLCH色空間を活用。 |
| **Internationalization** | **Lingui** | 読みやすく、自動化され、最適化された（3kb）i18nライブラリ。コンパイル時最適化対応。 |
| **ORM** | **Drizzle ORM** | TypeScriptファーストで軽量。SQLライクな操作が可能で、複数DBへの対応が容易。 |
| **Queue** | **Dragonfly** / **BullMQ** | VPS環境における非同期ジョブ処理（ActivityPub配送等）。Redis互換。 |
| **Code Quality** | **oxc** | Rustベースのツールチェーン（Linting & Formatting）。ESLint/Prettierの代替。 |

-----

## 3\. アーキテクチャと抽象化設計

環境依存（DB、ストレージ）をビジネスロジックから切り離すため、**Repository Pattern** および **Adapter Pattern** を採用する。

### 3.1 ディレクトリ構造案

```text
src/
├── adapters/           # インフラ実装 (Adapter Pattern)
│   ├── storage/
│   │   ├── LocalStorageAdapter.ts
│   │   └── S3StorageAdapter.ts
│   └── email/          # (Future)
├── db/
│   ├── schema/         # Drizzleスキーマ定義
│   │   ├── pg.ts       # PostgreSQL用
│   │   ├── mysql.ts    # MySQL/MariaDB用
│   │   └── sqlite.ts   # SQLite/D1用
│   └── index.ts        # DB接続初期化
├── interfaces/         # 抽象定義 (Interface)
│   ├── IFileStorage.ts
│   └── repositories/
│       ├── INoteRepository.ts
│       └── IUserRepository.ts
├── repositories/       # DB操作の実装 (Repository Pattern)
│   ├── pg/             # Postgres用実装
│   ├── mysql/          # MySQL用実装
│   └── d1/             # D1(SQLite)用実装
├── services/           # ビジネスロジック
├── routes/             # Honoエンドポイント
└── index.ts            # アプリケーションエントリーポイント
```

### 3.2 データベース抽象化 (Database Layer)

利用者は環境変数 `DB_TYPE` により、バックエンドDBを選択可能とする。

* **対応データベース:**
  * PostgreSQL (Default/Recommended for VPS)
  * MySQL / MariaDB
  * SQLite / Cloudflare D1
* **実装方針:**
  * `INoteRepository` などのインターフェースを定義し、Controller（Hono Route）はこれにのみ依存する。
  * アプリケーション起動時（DIコンテナ構築時）に、環境変数に応じて具体的なRepositoryクラス（`PostgresNoteRepo` や `D1NoteRepo`）を注入する。

### 3.3 ストレージ抽象化 (Storage Layer)

利用者は環境変数 `STORAGE_TYPE` により、メディア保存先を選択可能とする。

* **対応ストレージ:**
  * **Local:** ローカルファイルシステムへの保存（`Bun.write`利用）。主に開発用および単一サーバー運用用。
  * **S3 Compatible:** AWS S3, Cloudflare R2, MinIO 等への保存（AWS SDK利用）。
* **実装方針:**
  * `IFileStorage` インターフェース (`save`, `delete`, `getUrl`) を定義する。
  * S3互換ストレージの場合、エンドポイント、リージョン、クレデンシャルは環境変数から読み込む。

-----

## 4\. 機能要件 (Phased Implementation)

### Phase 1: 基盤構築 (Foundation) ✅ 完了

* [x] Bun + Hono プロジェクトの初期化（モノレポ構成）。
* [x] Drizzle ORMのセットアップ。
  * PostgreSQL スキーマ定義とマイグレーション環境の構築完了。
* [x] 環境変数 (`.env`) によるDB/ストレージの切り替えロジック実装。
* [x] 依存性注入 (DI) 機構の構築（Hono Contextの活用）。

### Phase 2: Misskey互換API実装 (Local API) ✅ 完了

* [x] **認証:** セッション生成、認証確認 (`/api/auth/*`)
  * トークンベース認証、セッション管理
  * Passkey対応（WebAuthn）
* [x] **アカウント管理:**
  * ユーザー登録 (`/api/users`)
  * プロフィール編集 (`/api/users/@me`)
  * ユーザー情報取得 (`/api/users/:id`, `/api/users/show`)
* [x] **ノート機能:**
  * 投稿作成 (`/api/notes/create`): テキスト、画像添付、CW、公開範囲、返信、リノート対応
  * タイムライン取得: ローカル、ソーシャル、ホームタイムライン (`/api/notes/*-timeline`)
  * ユーザータイムライン (`/api/notes/user-notes`)
  * リアクション (`/api/notes/reactions/*`): 絵文字の付与・削除
  * 投稿削除 (`/api/notes/delete`)
* [x] **フォロー機能:**
  * フォロー/アンフォロー (`/api/following/*`)
  * フォロワー/フォロイング一覧取得 (`/api/users/followers`, `/api/users/following`)
* [x] **ファイル管理:** ドライブ機能 (`/api/drive/*`)
  * アップロード、削除、一覧取得
  * ローカルストレージ対応

### Phase 3: フロントエンド実装 (Waku Client) ✅ 完了

* [x] **環境構築:**
  * Waku 0.27.1 + Jotai セットアップ完了
  * Tailwind CSS v4 + OKLCH色空間カスタムカラー
  * Lingui による i18n 対応（日本語・英語、87メッセージ）
  * React Aria Components 導入
* [x] **認証フロー:**
  * ログイン/サインアップページ
  * Passkey認証対応（WebAuthn）
  * パスワード認証対応
  * セッション管理（localStorage永続化）
* [x] **タイムライン機能:**
  * ローカル/ソーシャル/ホームタイムライン表示
  * 無限スクロール（Intersection Observer + カスタムフック）
  * スケルトンローディング、エラー表示
  * タイムラインタブ切り替え
* [x] **投稿機能 (NoteComposer):**
  * テキスト投稿、画像添付（複数対応）
  * ドラッグ&ドロップでのファイルアップロード
  * 画像プレビュー表示
  * 返信、リノート機能
  * CW（Content Warning）対応
  * 公開範囲設定（public/home/followers）
  * ファイルアップロード進捗表示
* [x] **投稿表示 (NoteCard):**
  * リアクション表示・追加・削除
  * リノート機能
  * フォロー/アンフォローボタン
  * 画像モーダル（ズーム、パン、ギャラリーナビゲーション）
  * 投稿削除機能
  * Content Warning 展開機能
* [x] **ユーザープロフィールページ:**
  * プロフィール情報表示（アバター、バナー、自己紹介）
  * 統計情報（投稿数、フォロワー数、フォロー中数）
  * フォロー/アンフォローボタン
  * ユーザーの投稿一覧
  * 動的ルーティング（`/[username]`）
* [x] **UI/UXの改善:**
  * ローディングインジケーター（Spinner, ProgressBar, Skeleton）
  * エラー表示とリトライ機能
  * 画像全画面表示モーダル
  * レスポンシブデザイン
* [x] **アクセシビリティ対応:**
  * キーボードナビゲーション（j/k, 矢印キー, Home/End）
  * フォーカス管理（モーダルのフォーカストラップ）
  * ARIA属性の適切な設定（role, aria-label, aria-expanded等）
  * スクリーンリーダー対応（sr-only クラス活用）

### Phase 4: ActivityPub 連合 (Federation) ✅ 完了

* [x] **Actor実装:** `/users/:username` での JSON-LD (Person) 返却。
* [x] **WebFinger:** `/.well-known/webfinger` 実装。
* [x] **署名処理:** HTTP Signatures (RSA-SHA256 / hs2019) の実装。
* [x] **配送システム:**
  * Inbox (`/users/:username/inbox`) でのアクティビティ受信と検証。
  * Job Queue (Dragonfly/BullMQ) を用いた外部サーバーへの非同期配送。
* [x] **Activity対応:**
  * Follow/Accept/Reject/Undo(Follow)
  * Create/Update/Delete (Note)
  * Like/Undo(Like)
  * Announce/Undo(Announce)
* [x] **連合テスト完了:**
  * GoToSocial (Latest) - ✅ 動作確認済
  * Mastodon (v4.3.2) - ✅ 動作確認済
  * Misskey (v2025.11.1-alpha.2) - ✅ 動作確認済
* [x] **Misskey拡張対応:**
  * `_misskey_reaction` カスタム絵文字リアクション（受信）

### Phase 5: リファクタリング & 最適化 (Refactoring & Optimization)

* [ ] **コードリファクタリング:**
  * inbox.ts の分割（InboxService + Handlerパターン）
  * ActivityPubDeliveryService の責務分割
  * DIコンテナへのサービス統合
  * 動的import の整理
* [ ] **パフォーマンス最適化:**
  * Redisキャッシング（タイムライン、ユーザープロフィール）
  * データベース接続プーリング設定
  * クエリ結果キャッシュ（公開タイムライン）
* [ ] **画像処理:**
  * WebP変換・圧縮処理
  * メディアプロキシ実装
* [ ] **テスト拡充:**
  * 主要サービスのユニットテスト追加
  * インテグレーションテストの整備

### Phase 6: 管理機能 & セキュリティ強化 (Administration & Security)

* [ ] **管理機能:**
  * インスタンスブロック管理UI
  * モデレーション機能
  * 管理者ダッシュボード
* [ ] **セキュリティ強化:**
  * レート制限の強化（ActivityPub inbox）
  * 配送リトライロジックの改善
  * 構造化ログ導入（pino等）

### Phase 7: プラグイン & 本番環境 (Plugin & Production)

* [ ] **プラグインシステム:**
  * プラグインAPI設計
  * フックポイントの実装
  * サンプルプラグイン作成
* [ ] **本番環境対応:**
  * Docker Compose本番構成
  * 監視・アラート設定（Prometheus/Grafana）
  * バックアップ・リストア手順
  * ドキュメント整備

-----

## 5\. 非機能要件

* **セキュリティ:**
  * HTTP Signaturesの厳格な検証。
  * SQLインジェクション対策 (ORM利用により担保)。
  * XSS対策 (React/Wakuの標準エスケープ利用)。
* **パフォーマンス:**
  * Server Side Rendering (SSR/RSC) によるFirst Contentful Paint (FCP) の高速化。
  * 画像のWebP変換・圧縮処理（オプション）。
* **拡張性:**
  * 将来的な「プラグインシステム」の導入を考慮し、コアロジックを疎結合に保つ。

-----

## 6\. 環境変数設定例 (.env.example)

```ini
# アプリケーション設定
PORT=3000
NODE_ENV=development
URL=https://myserver.example.com

# データベース設定 (postgres, mysql, sqlite, d1)
DB_TYPE=postgres
DATABASE_URL=postgres://user:pass@localhost:5432/mysns

# ストレージ設定 (local, s3)
STORAGE_TYPE=local
# S3設定 (STORAGE_TYPE=s3の場合)
S3_ENDPOINT=https://<accountid>.r2.cloudflarestorage.com
S3_BUCKET_NAME=my-bucket
S3_ACCESS_KEY=xxx
S3_SECRET_KEY=xxx
S3_REGION=auto
```

## 7\. 呼び方

* フロントエンド: Waku Rox
* APIサーバー: Hono Rox
